<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Organigramme</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}
#toolbar {
  padding: 10px;
  background: #f0f0f0;
  border-bottom: 1px solid #ccc;
}
#canvas {
  width: 100%;
  height: 90vh;
  cursor: default;
}
.node rect {
  stroke: #000;
  stroke-width: 1px;
}
.node text {
  pointer-events: none;
  user-select: none;
}
.line.dotted {
  stroke-dasharray: 5,5;
}
</style>
</head>
<body>
<div id="toolbar">
  <input type="text" id="roleInput" placeholder="Fonction">
  <input type="text" id="nameInput" placeholder="Nom">
  <input type="color" id="fillColor" value="#ffeeba">
  <select id="textColor">
    <option value="#000">Texte noir</option>
    <option value="#fff">Texte blanc</option>
  </select>
  <select id="lineStyle">
    <option value="solid">Trait continu</option>
    <option value="dotted">Pointillé</option>
  </select>
  <button id="addNode">Ajouter un poste</button>
  <span id="info"></span>
</div>
<svg id="canvas"></svg>
<script>
let svg = document.getElementById('canvas');
let addNodeBtn = document.getElementById('addNode');
let lineStyleSelect = document.getElementById('lineStyle');
let fillColorInput = document.getElementById('fillColor');
let roleInput = document.getElementById('roleInput');
let nameInput = document.getElementById('nameInput');
let textColorSelect = document.getElementById('textColor');
let selectedNode = null;
let nodeCount = 0;
let nodes = [];
let lines = [];
const NODE_WIDTH = 150;
const NODE_HEIGHT = 60;

function createSVGElement(tag, attrs) {
  let el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (let k in attrs) el.setAttribute(k, attrs[k]);
  return el;
}

function addNode() {
  const role = roleInput.value || `Fonction ${nodeCount + 1}`;
  const name = nameInput.value || `Nom ${nodeCount + 1}`;
  const color = fillColorInput.value;
  const textColor = textColorSelect.value;
  const x = 50 + nodeCount * 40;
  const y = 50 + nodeCount * 20;
  const g = createSVGElement('g', { class: 'node', transform: `translate(${x},${y})`, 'data-id': nodeCount });
  const rect = createSVGElement('rect', { x: 0, y: 0, width: NODE_WIDTH, height: NODE_HEIGHT, fill: color, rx: 10, ry: 10 });
  const roleText = createSVGElement('text', { x: NODE_WIDTH / 2, y: 20, 'text-anchor': 'middle', 'font-weight': 'bold', fill: textColor });
  roleText.textContent = role;
  const nameText = createSVGElement('text', { x: NODE_WIDTH / 2, y: 40, 'text-anchor': 'middle', fill: textColor });
  nameText.textContent = name;
  g.appendChild(rect);
  g.appendChild(roleText);
  g.appendChild(nameText);
  svg.appendChild(g);
  nodes.push({ g });
  makeDraggable(g);
  nodeCount++;
}

function makeDraggable(element) {
  let offset = null;
  element.addEventListener('mousedown', (e) => {
    selectedNode = element;
    const rect = svg.getBoundingClientRect();
    const t = getTranslation(element);
    offset = { x: e.clientX - rect.left - t.x, y: e.clientY - rect.top - t.y };
  });
  svg.addEventListener('mousemove', (e) => {
    if (selectedNode && offset) {
      const rect = svg.getBoundingClientRect();
      const x = e.clientX - rect.left - offset.x;
      const y = e.clientY - rect.top - offset.y;
      selectedNode.setAttribute('transform', `translate(${x},${y})`);
      updateLines();
    }
  });
  window.addEventListener('mouseup', () => {
    selectedNode = null;
    offset = null;
  });
  element.addEventListener('click', handleNodeClick);
}

let connectionStart = null;

function handleNodeClick(e) {
  const node = e.currentTarget;
  if (!connectionStart) {
    connectionStart = node;
    document.getElementById('info').textContent = 'Sélectionnez un second poste pour créer le lien.';
  } else if (connectionStart !== node) {
    connectNodes(connectionStart, node);
    connectionStart = null;
    document.getElementById('info').textContent = '';
  }
  e.stopPropagation();
}

svg.addEventListener('click', () => {
  connectionStart = null;
  document.getElementById('info').textContent = '';
});

function connectNodes(n1, n2) {
  const line = createSVGElement('line', { class: `line ${lineStyleSelect.value}`, 'data-n1': n1.getAttribute('data-id'), 'data-n2': n2.getAttribute('data-id'), stroke: '#000', 'stroke-width': 2 });
  svg.insertBefore(line, svg.firstChild); // draw lines behind nodes
  lines.push(line);
  updateLines();
}

function getTranslation(el) {
  const m = /translate\(([^,]+),([^\)]+)\)/.exec(el.getAttribute('transform'));
  return { x: m ? parseFloat(m[1]) : 0, y: m ? parseFloat(m[2]) : 0 };
}

function updateLines() {
  lines.forEach(line => {
    const id1 = line.getAttribute('data-n1');
    const id2 = line.getAttribute('data-n2');
    const node1 = nodes.find(n => n.g.getAttribute('data-id') === id1);
    const node2 = nodes.find(n => n.g.getAttribute('data-id') === id2);
    const t1 = getTranslation(node1.g);
    const t2 = getTranslation(node2.g);
    const x1 = t1.x + NODE_WIDTH / 2;
    const y1 = t1.y + NODE_HEIGHT / 2;
    const x2 = t2.x + NODE_WIDTH / 2;
    const y2 = t2.y + NODE_HEIGHT / 2;
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
  });
}

addNodeBtn.addEventListener('click', addNode);
</script>
</body>
</html>
